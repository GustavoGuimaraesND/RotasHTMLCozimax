<!DOCTYPE html>
<html lang=\"pt-br\">
<head>
  <meta charset=\"utf-8\" />
  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />
  <title>Viagem 0</title>
  <script src=\"https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js\"></script>
  <link href=\"https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css\" rel=\"stylesheet\"/>
  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #map { position:absolute; inset:0; }
    .panel { position:absolute; top:12px; left:12px; background:#ffffffee; padding:10px 12px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.12); font-size:14px; }
  </style>
</head>
<body>
  <div id=\"map\"></div>
  <div class=\"panel\" id=\"panel\">Viagem <b>0</b> — <span id=\"stats\">calculando…</span></div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZ3VzdGF2b2d1aW1hcmFlczkyIiwiYSI6ImNtZWxkb2s1OTBhcWwyanB4d3Jmbmc4czcifQ.LlTflYzcZieKdmOmDo85_w';
const PROFILE = 'driving';
const OVERVIEW = 'full';
const STEPS = false;

const coords = [[-49.488604, -20.805254], [-49.320355, -20.534071], [-49.192003, -20.339537], [-49.203059, -20.281916], [-46.370827, -14.086387], [-44.995348, -12.147748], [-38.22158, -8.96186], [-39.283899, -11.563472], [-38.99659, -11.48281], [-37.425444, -11.243418], [-37.673433, -10.919582], [-37.496939, -10.747893], [-36.633143, -9.406106], [-37.617164, -5.079335], [-37.450427, -6.491354], [-35.4451, -7.877335], [-35.24368, -7.845002], [-35.013143, -7.563015], [-35.291112, -6.615057], [-35.130104, -6.381057], [-35.310713, -6.332094], [-37.640264, -8.086168], [-38.149883, -9.105204], [-38.400836, -9.587492], [-37.659948, -10.070828], [-38.377571, -10.592741], [-49.488604, -20.805254]];       // [[lon,lat], ...] (para rota)
const points = [{"lon": -49.488604, "lat": -20.805254, "m3": 0.0}, {"lon": -49.320355, "lat": -20.534071, "m3": 1.05}, {"lon": -49.192003, "lat": -20.339537, "m3": 2.26}, {"lon": -49.203059, "lat": -20.281916, "m3": 2.99}, {"lon": -46.370827, "lat": -14.086387, "m3": 0.08}, {"lon": -44.995348, "lat": -12.147748, "m3": 0.16}, {"lon": -38.22158, "lat": -8.96186, "m3": 4.27}, {"lon": -39.283899, "lat": -11.563472, "m3": 0.81}, {"lon": -38.99659, "lat": -11.48281, "m3": 0.86}, {"lon": -37.425444, "lat": -11.243418, "m3": 5.86}, {"lon": -37.673433, "lat": -10.919582, "m3": 8.16}, {"lon": -37.496939, "lat": -10.747893, "m3": 1.8}, {"lon": -36.633143, "lat": -9.406106, "m3": 1.71}, {"lon": -37.617164, "lat": -5.079335, "m3": 1.97}, {"lon": -37.450427, "lat": -6.491354, "m3": 1.11}, {"lon": -35.4451, "lat": -7.877335, "m3": 6.08}, {"lon": -35.24368, "lat": -7.845002, "m3": 3.05}, {"lon": -35.013143, "lat": -7.563015, "m3": 2.93}, {"lon": -35.291112, "lat": -6.615057, "m3": 2.66}, {"lon": -35.130104, "lat": -6.381057, "m3": 1.08}, {"lon": -35.310713, "lat": -6.332094, "m3": 2.01}, {"lon": -37.640264, "lat": -8.086168, "m3": 1.0}, {"lon": -38.149883, "lat": -9.105204, "m3": 1.09}, {"lon": -38.400836, "lat": -9.587492, "m3": 0.38}, {"lon": -37.659948, "lat": -10.070828, "m3": 3.0}, {"lon": -38.377571, "lat": -10.592741, "m3": 3.16}, {"lon": -49.488604, "lat": -20.805254, "m3": 0.0}];       // [{lon,lat,m3}, ...] alinhado a coords
const volume = 59.540000000000006;          // m³ total da viagem (número)

function chunkPoints(points, maxPerReq=25){
  if(points.length <= maxPerReq) return [points];
  const out=[]; let i=0;
  while(i < points.length-1){
    const end = Math.min(i + maxPerReq - 1, points.length - 1);
    out.push(points.slice(i, end+1));
    if(end === points.length-1) break;
    i = end; // reusa o último ponto como primeiro do próximo bloco
  }
  return out;
}

function buildDirectionsURL(cs){
  const s = cs.map(c => c.join(',')).join(';');
  const p = new URLSearchParams({ overview: OVERVIEW, steps: String(STEPS), geometries: 'geojson' });
  return 'https://api.mapbox.com/directions/v5/mapbox/' + PROFILE + '/' + s + '?' + p.toString() + '&access_token=' + mapboxgl.accessToken;
}

async function fetchRoute(cs){
  const r = await fetch(buildDirectionsURL(cs));
  if(!r.ok) throw new Error('Directions falhou: ' + r.status);
  const j = await r.json();
  if(!j.routes || !j.routes[0]) throw new Error('Sem rota retornada');
  return j.routes[0];
}

function fmtKm(m){ return (m/1000).toLocaleString('pt-BR', {maximumFractionDigits:1}); }
function fmtDur(s){ const h=Math.floor(s/3600), m=Math.round((s%3600)/60); return h>0? (h+'h '+m+'min') : (m+'min'); }

(function(){
  const panel = document.getElementById('stats');
  const map = new mapboxgl.Map({ container:'map', style:'mapbox://styles/mapbox/streets-v12', center: coords[0] || [0,0], zoom: 8 });

  // Reporta erros de estilo/token para não travar no "calculando..."
  map.on('error', (e)=>{
    console.error('Mapbox GL JS error:', e && e.error);
    if (panel) panel.textContent = 'Erro ao carregar mapa/estilo. Verifique o token e os domínios permitidos do Mapbox.';
  });

  map.addControl(new mapboxgl.NavigationControl(), 'top-right');

  map.on('load', async ()=>{
    try{
      if(!Array.isArray(coords) || coords.length < 2){
        panel.textContent = 'Rota inválida: é necessário ao menos 2 pontos.';
        return;
      }
      const chunks = chunkPoints(coords,25);
      let dist=0, dur=0; const lines=[];
      for(const ch of chunks){
        const route = await fetchRoute(ch);
        dist += route.distance || 0; dur += route.duration || 0;
        if(route.geometry) { for (const c of route.geometry.coordinates) { lines.push(c); } }
      }

      // Features: line + points com propriedades
      const features = [ { type:'Feature', geometry:{ type:'LineString', coordinates: lines } } ];
      const n = coords.length;
      for(let i=0;i<n;i++){
        const c = coords[i];
        const p = points && points[i] ? points[i] : {m3:0};
        const isDepot = (i===0 || i===n-1);
        const order = isDepot ? '' : String(i); // 1..N somente para paradas, depósitos sem número
        features.push({
          type:'Feature',
          geometry:{ type:'Point', coordinates:c },
          properties:{ order: order, m3_stop: Number(p.m3||0).toFixed(1), is_depot: isDepot }
        });
      }

      map.addSource('route', { type:'geojson', data:{ type:'FeatureCollection', features } });

      map.addLayer({ id:'line', type:'line', source:'route',
        paint:{ 'line-color':'#1e88e5','line-width':4 },
        filter:['==',['geometry-type'],'LineString']
      });
      map.addLayer({ id:'pts', type:'circle', source:'route',
        paint:{ 'circle-radius':6,'circle-stroke-width':1.5,'circle-stroke-color':'#fff','circle-color':'#1e88e5' },
        filter:['==',['geometry-type'],'Point']
      });
      map.addLayer({ id:'labels', type:'symbol', source:'route',
        layout:{ 'text-field':['get','order'], 'text-size':12, 'text-offset':[0,0.8], 'text-anchor':'top' },
        paint:{ 'text-color':'#000000', 'text-halo-color':'#ffffff', 'text-halo-width':1.5 },
        filter:['all',['==',['geometry-type'],'Point'], ['!=',['get','order'],'']]
      });

      // Tooltip de m3 por parada
      const popup = new mapboxgl.Popup({ closeButton:false, closeOnClick:false });
      map.on('mouseenter','pts', (e)=>{
        map.getCanvas().style.cursor = 'pointer';
        const f = e.features && e.features[0];
        if(!f) return;
        const o = f.properties.order;
        const m3s = f.properties.m3_stop;
        const isDepot = String(f.properties.is_depot) === 'true';
        const title = isDepot ? 'Depósito' : `Ponto ${o}`;
        popup.setLngLat(f.geometry.coordinates)
             .setHTML(`<div style=\"font: 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto\"><b>0</b><br/>Volume: <b>${m3s}</b> m³</div>`)
             .addTo(map);
      });
      map.on('mouseleave','pts', ()=>{ map.getCanvas().style.cursor = ''; popup.remove(); });

      // Fit bounds
      const lons = coords.map(c=>c[0]), lats = coords.map(c=>c[1]);
      const b = [[Math.min(...lons), Math.min(...lats)],[Math.max(...lons), Math.max(...lats)]];
      map.fitBounds(b, {padding:60, duration:0});

      // Painel
      panel.textContent = 'Distância: ' + fmtKm(dist) + ' km · Duração: ' + fmtDur(dur) + ' · Volume: ' + Number(volume||0).toLocaleString('pt-BR', {maximumFractionDigits:1}) + ' m³';
    }catch(err){
      console.error(err);
      panel.textContent = 'Erro ao calcular rota: ' + (err && err.message ? err.message : String(err));
    }
  });
})();
</script>
</body>
</html>