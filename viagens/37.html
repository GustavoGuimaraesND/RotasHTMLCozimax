<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Viagem 37</title>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #map { position:absolute; inset:0; }
    .panel { position:absolute; top:12px; left:12px; background: rgba(255,255,255,0.93); padding:10px 12px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.12); font-size:14px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="panel" id="panel">Viagem <b>37</b> — <span id="stats">calculando…</span></div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZ3VzdGF2b2d1aW1hcmFlczkyIiwiYSI6ImNtZWxkb2s1OTBhcWwyanB4d3Jmbmc4czcifQ.LlTflYzcZieKdmOmDo85_w';
const PROFILE = 'driving';
const OVERVIEW = 'full';
const STEPS = false;

// Lista de pontos com m³ agregado e metadados
// Estrutura: [{lon,lat,m3,isDepot,label}, ...] onde label é string vazia nos depósitos
const points = [{"lon": -49.488604, "lat": -20.805254, "m3": 0.0, "isDepot": true, "label": ""}, {"lon": -51.2308, "lat": -22.7815, "m3": 2.379, "isDepot": false, "label": "1"}, {"lon": -51.5967, "lat": -22.8193, "m3": 2.285, "isDepot": false, "label": "2"}, {"lon": -51.7147, "lat": -22.7895, "m3": 1.349, "isDepot": false, "label": "3"}, {"lon": -51.7974, "lat": -22.6961, "m3": 3.177, "isDepot": false, "label": "4"}, {"lon": -51.7983, "lat": -22.9135, "m3": 0.921, "isDepot": false, "label": "5"}, {"lon": -51.5339, "lat": -23.1094, "m3": 1.822, "isDepot": false, "label": "6"}, {"lon": -51.7736, "lat": -23.1465, "m3": 0.607, "isDepot": false, "label": "7"}, {"lon": -51.9331, "lat": -23.421, "m3": 2.007, "isDepot": false, "label": "8"}, {"lon": -52.4622, "lat": -23.0821, "m3": 1.4249999999999998, "isDepot": false, "label": "9"}, {"lon": -52.7871, "lat": -23.0947, "m3": 4.021, "isDepot": false, "label": "10"}, {"lon": -53.1346, "lat": -22.931, "m3": 4.905, "isDepot": false, "label": "11"}, {"lon": -53.6155, "lat": -23.3948, "m3": 0.17, "isDepot": false, "label": "12"}, {"lon": -53.4595, "lat": -24.9578, "m3": 0.827, "isDepot": false, "label": "13"}, {"lon": -52.99, "lat": -24.5428, "m3": 2.326, "isDepot": false, "label": "14"}, {"lon": -52.3781, "lat": -24.0437, "m3": 0.293, "isDepot": false, "label": "15"}, {"lon": -51.8573, "lat": -23.8639, "m3": 1.403, "isDepot": false, "label": "16"}, {"lon": -51.6878, "lat": -23.5168, "m3": 0.729, "isDepot": false, "label": "17"}, {"lon": -51.4264, "lat": -23.4158, "m3": 0.174, "isDepot": false, "label": "18"}, {"lon": -51.3768, "lat": -23.316, "m3": 2.081, "isDepot": false, "label": "19"}, {"lon": -51.281, "lat": -23.278, "m3": 0.994, "isDepot": false, "label": "20"}, {"lon": -51.1696, "lat": -23.3045, "m3": 0.678, "isDepot": false, "label": "21"}, {"lon": -49.9777, "lat": -23.1579, "m3": 5.558, "isDepot": false, "label": "22"}, {"lon": -49.9106, "lat": -23.5678, "m3": 0.551, "isDepot": false, "label": "23"}, {"lon": -50.1924, "lat": -23.8401, "m3": 0.276, "isDepot": false, "label": "24"}, {"lon": -51.4628, "lat": -25.3907, "m3": 2.839, "isDepot": false, "label": "25"}, {"lon": -50.9774, "lat": -25.2119, "m3": 0.369, "isDepot": false, "label": "26"}, {"lon": -49.2671, "lat": -25.429, "m3": 0.51, "isDepot": false, "label": "27"}, {"lon": -49.3357, "lat": -24.1089, "m3": 1.133, "isDepot": false, "label": "28"}, {"lon": -48.8769, "lat": -23.9793, "m3": 0.005, "isDepot": false, "label": "29"}, {"lon": -48.0488, "lat": -23.5891, "m3": 10.439, "isDepot": false, "label": "30"}, {"lon": -46.6333, "lat": -23.5505, "m3": 0.22799999999999998, "isDepot": false, "label": "31"}, {"lon": -46.7962, "lat": -23.5372, "m3": 0.196, "isDepot": false, "label": "32"}, {"lon": -47.2079, "lat": -23.0882, "m3": 3.242, "isDepot": false, "label": "33"}, {"lon": -49.488604, "lat": -20.805254, "m3": 0.0, "isDepot": true, "label": ""}];
const total_m3 = 59.919;

// Coords para Directions
const coords = points.map(p => [p.lon, p.lat]);

function chunkPoints(points, maxPerReq=25){
  if(points.length <= maxPerReq) return [points];
  const out=[]; let i=0;
  while(i < points.length-1){
    const end = Math.min(i + maxPerReq - 1, points.length - 1);
    out.push(points.slice(i, end+1));
    if(end === points.length-1) break;
    i = end; // sobrepõe último ponto para conectar com próximo bloco
  }
  return out;
}

function buildDirectionsURL(cs){
  const s = cs.map(c => c.join(',')).join(';');
  const p = new URLSearchParams({ overview: OVERVIEW, steps: String(STEPS), geometries: 'geojson' });
  return 'https://api.mapbox.com/directions/v5/mapbox/' + PROFILE + '/' + s + '?' + p.toString() + '&access_token=' + mapboxgl.accessToken;
}

async function fetchRoute(cs){
  const r = await fetch(buildDirectionsURL(cs));
  if(!r.ok) throw new Error('Directions falhou: ' + r.status);
  const j = await r.json();
  if(!j.routes || !j.routes[0]) throw new Error('Sem rota retornada');
  return j.routes[0];
}

function fmtKm(m){ return (m/1000).toLocaleString('pt-BR', {maximumFractionDigits:1}); }
function fmtDur(s){ const h=Math.floor(s/3600), m=Math.round((s%3600)/60); return h>0? (h+'h '+m+'min') : (m+'min'); }
function fmtM3(x){ return Number(x||0).toLocaleString('pt-BR', {maximumFractionDigits:2}); }

(function(){
  const map = new mapboxgl.Map({ container:'map', style:'mapbox://styles/mapbox/streets-v12', center: coords[0], zoom: 8 });
  map.addControl(new mapboxgl.NavigationControl(), 'top-right');
  map.on('load', async ()=>{
    try{
      const chunks = chunkPoints(coords,25);
      let dist=0, dur=0; const lines=[];
      for(const ch of chunks){
        const route = await fetchRoute(ch);
        dist += route.distance || 0; dur += route.duration || 0;
        if(route.geometry) { for (const c of route.geometry.coordinates) { lines.push(c); } }
      }

      // Monta features (linha + pontos com propriedades label e m3)
      const pointFeatures = points.map((p)=>({
        type:'Feature',
        geometry:{ type:'Point', coordinates:[p.lon, p.lat] },
        properties:{ label: String(p.label||''), m3: Number(p.m3||0), isDepot: p.isDepot ? 1 : 0 }
      }));

      map.addSource('route', { type:'geojson', data:{ type:'FeatureCollection', features:[
        { type:'Feature', geometry:{ type:'LineString', coordinates: lines } },
        ...pointFeatures
      ]}});

      map.addLayer({ id:'line', type:'line', source:'route',
        paint:{ 'line-color':'#1e88e5','line-width':4 },
        filter:['==',['geometry-type'],'LineString']
      });
      map.addLayer({ id:'pts', type:'circle', source:'route',
        paint:{ 'circle-radius':6,'circle-stroke-width':1.5,'circle-stroke-color':'#fff','circle-color':'#1e88e5' },
        filter:['all',['==',['geometry-type'],'Point']]
      });
      map.addLayer({ id:'labels', type:'symbol', source:'route',
        layout:{ 'text-field':['get','label'], 'text-size':12, 'text-offset':[0,0.8], 'text-anchor':'top' },
        paint:{ 'text-color':'#000000', 'text-halo-color':'#ffffff', 'text-halo-width':1.5 },
        filter:['all',['==',['geometry-type'],'Point']]
      });

      // Tooltip de m³ apenas para paradas numeradas (não exibe para depósito)
      const popup = new mapboxgl.Popup({ closeButton:false, closeOnClick:false });
      map.on('mouseenter', 'pts', (e)=>{
        const f = e.features && e.features[0];
        if(!f) return;
        if((f.properties.isDepot|0) === 1) { map.getCanvas().style.cursor=''; popup.remove(); return; }
        map.getCanvas().style.cursor = 'pointer';
        const { label, m3 } = f.properties;
        const [x,y] = f.geometry.coordinates;
        popup.setLngLat([x,y]).setHTML(`<div style="font: 12px/1.4 system-ui">Ponto <b>${label}</b><br/>M³: <b>${fmtM3(m3)}</b></div>`).addTo(map);
      });
      map.on('mouseleave', 'pts', ()=>{ map.getCanvas().style.cursor = ''; popup.remove(); });

      // Fit bounds
      const lons = coords.map(c=>c[0]), lats = coords.map(c=>c[1]);
      const b = [[Math.min(...lons), Math.min(...lats)],[Math.max(...lons), Math.max(...lats)]];
      map.fitBounds(b, {padding:60, duration:0});

      // Stats com m³ total
      document.getElementById('stats').textContent = 'Distância: ' + fmtKm(dist) + ' km · Duração: ' + fmtDur(dur) + ' · M³: ' + fmtM3(total_m3);
    }catch(err){
      console.error(err);
      document.getElementById('stats').textContent = 'Erro ao calcular rota: ' + err.message;
    }
  });
})();
</script>
</body>
</html>